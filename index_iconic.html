<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ICONIC GYM Â· Offline</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#101018; --muted:#616175; --line:#e6e6f2;
      --accent:#6b4eff; --accent2:#ff4ea1; --good:#13a36f; --warn:#e09b00; --bad:#d43434;
      --shadow: 0 8px 24px rgba(16,16,24,.08); --radius: 18px; --tap: 52px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;
      padding-bottom: calc(84px + env(safe-area-inset-bottom));}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(135deg, rgba(107,78,255,.12), rgba(255,78,161,.10));
      backdrop-filter: blur(10px);border-bottom:1px solid var(--line);}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .topRow{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:14px;height:14px;border-radius:999px;background:radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2)),
      linear-gradient(135deg, var(--accent), var(--accent2));box-shadow:0 8px 18px rgba(107,78,255,.18);}
    h1{font-size:18px;margin:0;letter-spacing:.3px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{font-size:12px;border:1px solid var(--line);background:rgba(255,255,255,.72);padding:8px 10px;border-radius:999px;
      color:var(--muted);display:flex;gap:8px;align-items:center;box-shadow: 0 6px 16px rgba(16,16,24,.05);}
    .pill b{color:var(--text)}
    main{padding:16px}
    .grid{display:grid;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow: var(--shadow);overflow:hidden;}
    .cardHead{padding:14px 14px 10px 14px;display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      border-bottom:1px solid var(--line);background:linear-gradient(180deg, rgba(107,78,255,.06), rgba(255,255,255,0));}
    .cardHead h2{margin:0;font-size:16px}
    .cardHead .hint{font-size:12px;color:var(--muted);margin-top:2px}
    .cardBody{padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{height:var(--tap);padding:0 14px;border-radius:14px;border:1px solid var(--line);background:#fff;font-weight:650;
      font-size:14px;color:var(--text);box-shadow:0 10px 18px rgba(16,16,24,.06);display:inline-flex;align-items:center;
      justify-content:center;gap:10px;cursor:pointer;user-select:none;-webkit-tap-highlight-color: transparent;}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg, var(--accent), var(--accent2));color:#fff;border-color:transparent;
      box-shadow: 0 14px 24px rgba(107,78,255,.22);}
    .btn.good{background:rgba(19,163,111,.10); border-color:rgba(19,163,111,.35)}
    .btn.bad{background:rgba(212,52,52,.08); border-color:rgba(212,52,52,.28)}
    .btn.small{height:42px;font-size:13px;border-radius:12px}
    .btn.ghost{background:transparent; box-shadow:none}
    .tag{display:inline-flex;gap:8px;align-items:center;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.76);color:var(--muted);}
    .tag.ok{border-color:rgba(19,163,111,.35); background:rgba(19,163,111,.08); color:#0b5c3f}
    .tag.lock{border-color:rgba(224,155,0,.35); background:rgba(224,155,0,.10); color:#7a5300}
    .tag.pr{border-color:rgba(107,78,255,.35); background:rgba(107,78,255,.10); color:#2c1fb0}
    .split{display:grid;grid-template-columns: 1fr;gap:14px;}
    @media(min-width:860px){.split{grid-template-columns: 1.2fr .8fr}}
    .tabs{position:fixed;left:0;right:0;bottom:0;padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.85);backdrop-filter: blur(14px);border-top:1px solid var(--line);
      display:flex;gap:10px;justify-content:space-around;z-index:40;}
    .tab{flex:1;min-width:0;border:1px solid var(--line);background:#fff;height:58px;border-radius:16px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-weight:700;font-size:12px;color:var(--muted);
      box-shadow:0 10px 18px rgba(16,16,24,.06);cursor:pointer;-webkit-tap-highlight-color: transparent;}
    .tab .ico{font-size:18px;line-height:18px}
    .tab.active{background:linear-gradient(135deg, rgba(107,78,255,.16), rgba(255,78,161,.12));color:var(--text);
      border-color:rgba(107,78,255,.25);}
    .workoutTitle{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .exercise{border:1px solid var(--line);border-radius:16px;padding:12px;background:linear-gradient(180deg, rgba(107,78,255,.05), rgba(255,255,255,0));
      margin-bottom:10px;}
    .exHead{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px;}
    .exName{font-weight:800;font-size:14px;margin:0;}
    .exStats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;font-size:12px;color:var(--muted);}
    .mini{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:rgba(255,255,255,.75);
      padding:6px 8px;border-radius:999px;}
    .mini b{color:var(--text)}
    .sets{display:grid;grid-template-columns: 1fr 1fr 1fr 46px;gap:8px;align-items:center;}
    .sets .hdr{font-size:12px;color:var(--muted);padding:0 4px}
    .in{width:100%;height:46px;border-radius:12px;border:1px solid var(--line);padding:0 10px;font-size:15px;background:#fff;}
    .chk{width:46px;height:46px;border-radius:12px;border:1px solid var(--line);background:#fff;display:flex;
      align-items:center;justify-content:center;font-size:18px;cursor:pointer;}
    .chk.done{border-color:rgba(19,163,111,.35);background:rgba(19,163,111,.10);color:var(--good);}
    .hintBox{border:1px dashed rgba(107,78,255,.35);background:rgba(107,78,255,.06);border-radius:16px;padding:10px 12px;
      color:#2c1fb0;font-size:12px;line-height:1.35;}
    .two{display:grid;grid-template-columns:1fr;gap:10px;}
    @media(min-width:700px){.two{grid-template-columns:1fr 1fr}}
    .overlay{position:fixed;inset:0;background:rgba(16,16,24,.62);display:none;align-items:center;justify-content:center;z-index:80;padding:16px;}
    .overlay.show{display:flex}
    .modal{width:min(560px, 100%);background:#fff;border-radius:22px;border:1px solid var(--line);
      box-shadow:0 20px 50px rgba(0,0,0,.25);overflow:hidden;}
    .modalHead{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;background:linear-gradient(135deg, rgba(107,78,255,.12), rgba(255,78,161,.10));}
    .modalHead .t{font-weight:900}
    .modalBody{padding:14px}
    .bigTime{font-family:var(--mono);font-size:64px;font-weight:900;letter-spacing:1px;text-align:center;margin:6px 0;}
    .subTime{text-align:center;color:var(--muted);font-size:14px;margin-bottom:12px;}
    .bar{height:16px;border-radius:999px;border:1px solid var(--line);background:rgba(16,16,24,.04);overflow:hidden;margin:10px 0 14px;}
    .bar > div{height:100%;width:0%;background:linear-gradient(135deg, var(--accent), var(--accent2));transition:width .2s linear;}
    .modalActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .list{display:flex;flex-direction:column;gap:10px;}
    .session{border:1px solid var(--line);background:#fff;border-radius:16px;padding:12px;box-shadow:0 10px 18px rgba(16,16,24,.06);}
    .sessionTop{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start}
    .sessionTop b{font-size:14px}
    .sessionTop .meta{font-size:12px;color:var(--muted)}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{flex:1;min-width:140px;border:1px solid var(--line);border-radius:16px;padding:12px;
      background:linear-gradient(180deg, rgba(255,78,161,.06), rgba(255,255,255,0));}
    .kpi .n{font-weight:950;font-size:22px}
    .kpi .l{font-size:12px;color:var(--muted)}
    .sel{height:46px;border-radius:12px;border:1px solid var(--line);background:#fff;font-size:15px;padding:0 10px;width:100%;}
    canvas{width:100%;height:240px;border:1px solid var(--line);border-radius:16px;background:#fff}
    .footNote{font-size:12px;color:var(--muted);line-height:1.35}
    .dangerZone{border:1px solid rgba(212,52,52,.25);background:rgba(212,52,52,.06);border-radius:16px;padding:12px;color:#7e1f1f;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topRow">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <h1>ICONIC GYM Â· Offline</h1>
          <div class="sub">VivaGym Plaza EspaÃ±a Â· 9:00 AM Â· 40â€“60 min Â· sin pensar</div>
        </div>
      </div>
      <div class="pillRow" id="topPills"></div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="view"></div>
</main>

<nav class="tabs" role="navigation" aria-label="Secciones">
  <button class="tab active" data-tab="today" type="button"><div class="ico">âš¡</div><div>Hoy</div></button>
  <button class="tab" data-tab="routines" type="button"><div class="ico">ğŸ“‹</div><div>Rutinas</div></button>
  <button class="tab" data-tab="history" type="button"><div class="ico">ğŸ—“ï¸</div><div>Historial</div></button>
  <button class="tab" data-tab="progress" type="button"><div class="ico">ğŸ“ˆ</div><div>Progreso</div></button>
</nav>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modalHead">
      <div class="t" id="timerTitle">Circuito</div>
      <button class="btn small ghost" id="timerClose" type="button">Cerrar</button>
    </div>
    <div class="modalBody">
      <div class="subTime" id="timerMeta">2 rondas Â· 60s por ejercicio Â· transiciÃ³n</div>
      <div class="bigTime" id="timerTime">60</div>
      <div class="subTime" id="timerExercise">Preparada ğŸ’œ</div>
      <div class="bar"><div id="timerBar"></div></div>
      <div class="modalActions">
        <button class="btn primary" id="timerStart" type="button">Start</button>
        <button class="btn" id="timerPause" type="button">Pausa</button>
        <button class="btn bad" id="timerStop" type="button">Stop</button>
      </div>
      <div class="footNote" style="margin-top:12px">
        Tip: si no vibra, es normal: depende de permisos del mÃ³vil y del navegador.
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const LS_KEY = "iconicGymApp_v2_androidSafe";
  const now = () => new Date();

  const ROUTINES = [
    { id:"d1", phase:1, name:"DÃA 1 â€” CIRCUITO FULL BODY (40 min)", type:"circuit", rounds:2, workSec:60, restSec:15,
      sections:[
        {title:"GLÃšTEO & PIERNA", items:["Hip Thrust en Smith","Prensa inclinada (pies altos y abiertos)","AbducciÃ³n de cadera","Curl femoral tumbado","Zancadas caminando"]},
        {title:"ESPALDA & BRAZOS", items:["JalÃ³n al pecho","Remo sentado polea baja","Fondos en banco","Curl bÃ­ceps polea baja","Press hombro en mÃ¡quina"]},
        {title:"CORE", items:["Crunch en mÃ¡quina","Elevaciones de piernas en banco","Plancha frontal","Plancha lateral","Mountain climbers lentos"]},
      ]
    },
    { id:"d2", phase:1, name:"DÃA 2 â€” FUERZA ICONIC (GLÃšTEO & ESPALDA)", type:"strength", restHint:"Descanso 60â€“75 s",
      exercises:[
        {name:"Hip Thrust en Smith", sets:4, reps:"10â€“12"},
        {name:"Peso muerto rumano", sets:3, reps:"10"},
        {name:"Prensa inclinada", sets:3, reps:"12"},
        {name:"JalÃ³n al pecho", sets:3, reps:"10â€“12"},
        {name:"Remo sentado", sets:3, reps:"12"},
        {name:"AbducciÃ³n de cadera", sets:3, reps:"15"},
      ]
    },
    { id:"d3", phase:1, name:"DÃA 3 â€” CIRCUITO FULL BODY Â· VARIANTE (40 min)", type:"circuit", rounds:2, workSec:60, restSec:15,
      sections:[
        {title:"GLÃšTEO & PIERNA", items:["Sentadilla en Smith","ExtensiÃ³n de glÃºteo en polea","Prensa pies neutros","AbducciÃ³n de cadera","Step-up a banco"]},
        {title:"ESPALDA & BRAZOS", items:["JalÃ³n agarre estrecho","Remo en mÃ¡quina alta","TrÃ­ceps cuerda","Curl bÃ­ceps en mÃ¡quina","Elevaciones laterales mancuernas"]},
        {title:"CORE", items:["Crunch polea alta","Dead bug","Plancha con toques de hombro","Oblicuos en mÃ¡quina","Bicicleta abdominal lenta"]},
      ]
    },
    { id:"d4", phase:1, name:"DÃA 4 â€” FUERZA ICONIC (GLÃšTEO + CORE)", type:"strength", restHint:"Descanso 60â€“75 s",
      exercises:[
        {name:"Sentadilla sumo con mancuerna", sets:4, reps:"12"},
        {name:"Puente de glÃºteo en banco", sets:3, reps:"15"},
        {name:"Patada de glÃºteo en polea", sets:3, reps:"12 por pierna"},
        {name:"Curl femoral", sets:3, reps:"12"},
        {name:"Crunch mÃ¡quina", sets:3, reps:"15"},
        {name:"Elevaciones de piernas", sets:3, reps:"12"},
        {name:"Plancha lateral", sets:3, reps:"30 s por lado"},
      ]
    },
  ];

  function fresh(){
    return {version:2, settings:{gym:"VivaGym Plaza EspaÃ±a", time:"09:00"}, sessions:[], ui:{ lastRoutineId:"d1", lastTab:"today", lastProgressEx:null }};
  }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return fresh();
      const obj = JSON.parse(raw);
      return Object.assign(fresh(), obj);
    }catch(e){ return fresh(); }
  }
  let state = load();
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); renderTopPills(); }

  const $ = (sel, root=document)=>root.querySelector(sel);
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

  function fmtDateISO(dateStr){
    const d = new Date(dateStr+"T00:00:00");
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }
  function fmtTime(d){
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function isoDate(d){
    const x = new Date(d);
    x.setMinutes(x.getMinutes() - x.getTimezoneOffset());
    return x.toISOString().slice(0,10);
  }
  function clamp(n,a,b){return Math.max(a, Math.min(b,n));}
  function escapeHtml(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));}
  function flatExercises(r){ return r.type==="strength" ? r.exercises.map(x=>x.name) : r.sections.flatMap(s=>s.items); }

  function getLastForExercise(name){
    for(let i=state.sessions.length-1;i>=0;i--){
      const s = state.sessions[i];
      const ex = (s.exercises||[]).find(e=>e.name===name);
      if(ex && ex.sets && ex.sets.length){
        const lastSet = [...ex.sets].reverse().find(x => (x.w!=="" && x.w!=null) || (x.r!=="" && x.r!=null));
        return { sets: ex.sets, lastW: lastSet ? String(lastSet.w ?? "") : "", lastR: lastSet ? String(lastSet.r ?? "") : "", date: s.date };
      }
    }
    return null;
  }
  function getBestForExercise(name){
    let best=null;
    for(const s of state.sessions){
      const ex = (s.exercises||[]).find(e=>e.name===name);
      if(!ex || !ex.sets) continue;
      for(const st of ex.sets){
        const w = parseFloat(st.w);
        if(Number.isFinite(w)) best = (best===null || w>best) ? w : best;
      }
    }
    return best;
  }

  function isoWeekKey(dateStr){
    const d = new Date(dateStr+"T00:00:00");
    const day = (d.getDay()+6)%7;
    d.setDate(d.getDate() - day + 3);
    const firstThu = new Date(d.getFullYear(),0,4);
    const firstDay = (firstThu.getDay()+6)%7;
    firstThu.setDate(firstThu.getDate() - firstDay + 3);
    const week = 1 + Math.round((d - firstThu) / (7*24*3600*1000));
    return `${d.getFullYear()}-W${String(week).padStart(2,"0")}`;
  }
  function validWeeksCount(){
    const counts = {};
    for(const s of state.sessions){ const k = isoWeekKey(s.date); counts[k]=(counts[k]||0)+1; }
    let valid=0; for(const k in counts){ if(counts[k]>=3) valid++; }
    return {valid, counts};
  }
  function isPhase2Unlocked(){ return validWeeksCount().valid >= 8; }
  function todayCompletedRoutineIds(){
    const t = isoDate(now());
    const set = new Set();
    for(const s of state.sessions){ if(s.date===t) set.add(s.routineId); }
    return set;
  }
  function newestSession(){ return state.sessions.length ? state.sessions[state.sessions.length-1] : null; }

  const view = $("#view");

  function renderTopPills(){
    const {valid} = validWeeksCount();
    const unlocked = isPhase2Unlocked();
    const last = newestSession();
    const pills = [];
    pills.push(`<div class="pill">ğŸ“Œ <b>Sesiones</b> ${state.sessions.length}</div>`);
    pills.push(`<div class="pill">ğŸ—“ï¸ <b>Semanas vÃ¡lidas</b> ${valid}/8</div>`);
    pills.push(`<div class="pill">ğŸ”“ <b>Fase 2</b> ${unlocked ? "Desbloqueada" : "Bloqueada"}</div>`);
    if(last) pills.push(`<div class="pill">ğŸ•˜ <b>Ãšltima</b> ${fmtDateISO(last.date)} Â· ${escapeHtml(last.routineName)}</div>`);
    $("#topPills").innerHTML = pills.join("");
  }

  function setActiveTab(tab){
    state.ui.lastTab = tab; save();
    $$(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
    if(tab==="today") renderToday();
    if(tab==="routines") renderRoutines();
    if(tab==="history") renderHistory();
    if(tab==="progress") renderProgress();
  }

  function renderToday(){
    const completed = todayCompletedRoutineIds();
    const last = newestSession();
    const unlocked = isPhase2Unlocked();
    view.innerHTML = `
      <div class="split">
        <div class="grid">
          <div class="card">
            <div class="cardHead">
              <div>
                <h2>Hoy / Entrenar</h2>
                <div class="hint">Elige un dÃ­a y se rellenan tus Ãºltimos pesos/reps automÃ¡ticamente.</div>
              </div>
              <div class="row">
                <span class="tag ${unlocked ? "ok":"lock"}">${unlocked ? "ğŸ”“ Fase 2 desbloqueada" : "ğŸ”’ Fase 2 bloqueada"}</span>
              </div>
            </div>
            <div class="cardBody">
              <div class="two">
                ${ROUTINES.map(r=>{
                  const done = completed.has(r.id);
                  const icon = r.type==="circuit" ? "â±ï¸" : "ğŸ‹ï¸â€â™€ï¸";
                  return `<button class="btn ${done ? "good" : ""}" data-open="${r.id}" type="button">
                    ${icon} ${escapeHtml(r.name.replace("DÃA ","D"))} ${done ? " Â· âœ” COMPLETADO" : ""}
                  </button>`;
                }).join("")}
              </div>
              <div style="height:12px"></div>
              <div class="hintBox"><b>Auto-modo:</b> abre tu dÃ­a y entra en flow. Todo se guarda offline.</div>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="cardHead">
              <div><h2>Resumen</h2><div class="hint">Lo esencial.</div></div>
            </div>
            <div class="cardBody">
              <div class="kpiRow">
                <div class="kpi"><div class="n">${state.sessions.length}</div><div class="l">Sesiones totales</div></div>
                <div class="kpi"><div class="n">${validWeeksCount().valid}</div><div class="l">Semanas vÃ¡lidas (â‰¥3)</div></div>
              </div>
              <div style="height:12px"></div>
              ${
                last ? `<div class="session">
                  <div class="sessionTop">
                    <div><b>Ãšltima sesiÃ³n</b><div class="meta">${fmtDateISO(last.date)} Â· ${escapeH
